<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NHẬP BÁO BÀI CHO HỌC SINH (ONLINE)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, deleteDoc, setDoc, doc, onSnapshot, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CẤU HÌNH FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyBlQDKw1sp3AGApHwktlgjmHHSgFiB9nPQ",
            authDomain: "webtichdiem.firebaseapp.com",
            databaseURL: "https://webtichdiem-default-rtdb.firebaseio.com",
            projectId: "webtichdiem",
            storageBucket: "webtichdiem.firebasestorage.app",
            messagingSenderId: "1058141807277",
            appId: "1:1058141807277:web:b4acbd794e5847366d5c24",
            measurementId: "G-KQN9EGW0VB"
        };
        // -----------------------------------------------------------

        // Khởi tạo Firebase
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("Lỗi khởi tạo Firebase:", e);
            alert("Lỗi khởi tạo Firebase: " + e.message);
        }

        // Tên Collection trong database
        const DB_COLLECTION = 'baobai_data';

        // Gán biến vào window để dùng toàn cục
        window.db = db;
        window.auth = auth;
        window.collection = collection;
        window.addDoc = addDoc;
        window.deleteDoc = deleteDoc;
        window.setDoc = setDoc;
        window.doc = doc;
        window.onSnapshot = onSnapshot;
        window.query = query; 
        window.currentUser = null;
        window.DB_COLLECTION = DB_COLLECTION;

        // Authentication & Realtime Listener
        async function initApp() {
            if (!auth) return;

            try {
                // Đăng nhập ẩn danh
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Auth error:", error);
                if (error.code === 'auth/operation-not-allowed') {
                    alert("LỖI CẤU HÌNH:\nBạn chưa bật 'Anonymous' trong Authentication.\nVào Console -> Authentication -> Sign-in method -> Bật Anonymous lên.");
                } else {
                    alert("Lỗi đăng nhập: " + error.message);
                }
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    window.currentUser = user;
                    console.log("Connected as:", user.uid);
                    startRealtimeListener();
                }
            });
        }

        function startRealtimeListener() {
            if (!db) return;

            const q = collection(db, DB_COLLECTION);
            
            onSnapshot(q, (snapshot) => {
                const allData = [];
                snapshot.forEach((doc) => {
                    allData.push({ id: doc.id, ...doc.data() });
                });
                
                window.globalAppData = allData;
                
                const overlay = document.getElementById('loading-overlay');
                if(overlay) {
                    overlay.style.opacity = '0';
                    setTimeout(() => overlay.remove(), 500);
                }

                // Re-render
                if (window.currentView === 'view-class') {
                    renderClasses(window.currentGrade);
                } else if (window.currentView === 'view-dashboard') {
                    renderGallery();
                }
            }, (error) => {
                console.error("Data sync error:", error);
                if (error.code === 'permission-denied') {
                     document.getElementById('loading-overlay').style.display = 'flex';
                     document.getElementById('loading-overlay').style.opacity = '1';
                     document.getElementById('loading-overlay').innerHTML = `
                        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-md text-center m-4">
                            <i class="fa-solid fa-lock text-5xl text-red-500 mb-4"></i>
                            <h3 class="text-xl font-bold text-gray-800 mb-2">Chưa mở quyền truy cập!</h3>
                            <p class="text-gray-600 mb-4 text-sm">Vào Firestore Database > Rules và sửa thành:</p>
                            <code class="block bg-gray-100 p-2 rounded text-left text-xs mb-4 font-mono">allow read, write: if true;</code>
                            <button onclick="location.reload()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Tải lại trang</button>
                        </div>
                     `;
                } else {
                    showToast("Mất kết nối! Kiểm tra mạng.", true);
                }
            });
        }

        // --- CÁC HÀM XỬ LÝ CHÍNH ---

        async function handleFileUpload(event) {
            if (!window.currentUser) {
                alert("Chưa kết nối đến máy chủ! Vui lòng đợi hoặc tải lại trang.");
                return;
            }

            const files = Array.from(event.target.files);
            if (files.length === 0) return;

            const label = document.querySelector('label[for="file-upload"]');
            const originalContent = label.innerHTML;
            label.innerHTML = `<i class="fa-solid fa-spinner fa-spin text-xl"></i> <span>Đang xử lý...</span>`;
            label.classList.add('opacity-75', 'cursor-not-allowed');

            const compressAndRead = (file) => {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = (event) => {
                        const img = new Image();
                        img.src = event.target.result;
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            const maxWidth = 1000;
                            let width = img.width;
                            let height = img.height;
                            if (width > maxWidth) {
                                height *= maxWidth / width;
                                width = maxWidth;
                            }
                            canvas.width = width;
                            canvas.height = height;
                            ctx.drawImage(img, 0, 0, width, height);
                            const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                            resolve(dataUrl);
                        };
                        img.onerror = () => resolve(null);
                    };
                    reader.onerror = () => resolve(null);
                });
            };

            try {
                let successCount = 0;
                const collectionRef = window.collection(window.db, window.DB_COLLECTION);

                for (const file of files) {
                    const base64Image = await compressAndRead(file);
                    
                    if (base64Image && base64Image.length < 1000000) {
                        const now = new Date();
                        await window.addDoc(collectionRef, {
                            classId: window.currentClass,
                            type: 'image',
                            image: base64Image,
                            timestamp: now.getTime(),
                            date: now.toLocaleDateString('vi-VN'),
                            time: now.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' })
                        });
                        successCount++;
                    }
                }

                if (successCount > 0) {
                    showToast(`Đã đăng ${successCount} ảnh thành công!`);
                } else {
                    alert("Không thể tải ảnh! Có thể ảnh quá lớn.");
                }

            } catch (error) {
                console.error("Upload error:", error);
                alert("Lỗi tải lên: " + error.message);
            } finally {
                event.target.value = '';
                label.innerHTML = originalContent;
                label.classList.remove('opacity-75', 'cursor-not-allowed');
            }
        }

        async function deleteImage(docId, event) {
            if (event) event.stopPropagation();
            if (!window.currentUser) {
                alert("Chưa kết nối máy chủ.");
                return;
            }

            if (confirm("Bạn có chắc chắn muốn xóa ảnh này không?")) {
                try {
                    await window.deleteDoc(window.doc(window.db, window.DB_COLLECTION, docId));
                    showToast("Đã xóa ảnh thành công.");
                } catch (e) {
                    console.error(e);
                    alert("Chi tiết lỗi xóa: " + e.message + "\n(Mã lỗi: " + e.code + ")");
                }
            }
        }

        async function updateClassStatus() {
            if (!window.currentUser || !window.currentClass) return;

            const radiosStatus = document.getElementsByName('classStatus');
            let status = '';
            for (const r of radiosStatus) {
                if (r.checked) status = r.value;
            }

            const radiosTin2 = document.getElementsByName('tin2Status');
            let tin2Status = '';
            for (const r of radiosTin2) {
                if (r.checked) tin2Status = r.value;
            }

            const tin2 = document.getElementById('tin2-input').value;

            try {
                const statusDocId = 'status_' + window.currentClass;
                await window.setDoc(window.doc(window.db, window.DB_COLLECTION, statusDocId), {
                    classId: window.currentClass,
                    type: 'status',
                    status: status,
                    tin2: tin2,
                    tin2Status: tin2Status,
                    lastUpdate: new Date().getTime()
                }, { merge: true });

                console.log("Đã cập nhật trạng thái");
            } catch (e) {
                console.error("Lỗi lưu trạng thái:", e);
            }
        }

        // --- GẮN HÀM VÀO WINDOW ---
        window.handleFileUpload = handleFileUpload;
        window.deleteImage = deleteImage;
        window.updateClassStatus = updateClassStatus;
        
        // Khởi chạy
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Be Vietnam Pro', sans-serif;
            background-color: #ecfdf5;
            overflow-x: hidden;
        }
        
        #background-pattern {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            opacity: 0.15;
            pointer-events: none;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
            align-content: space-around;
            overflow: hidden;
        }
        .bg-icon {
            color: #059669;
            font-size: 2rem;
            margin: 30px;
            transform: rotate(0deg);
            transition: all 0.5s ease;
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.05));
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #ecfdf5; }
        ::-webkit-scrollbar-thumb { background: #10b981; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #059669; }
        
        /* Loading overlay */
        #loading-overlay {
            position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 100;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col text-gray-800">

    <div id="loading-overlay" class="transition-opacity duration-500">
        <i class="fa-solid fa-cloud-arrow-up text-6xl text-emerald-500 animate-bounce mb-4"></i>
        <p class="text-emerald-700 font-bold text-lg mt-4">Đang kết nối dữ liệu...</p>
        <p class="text-sm text-gray-500 mt-2">(Lần đầu có thể mất vài giây)</p>
    </div>

    <!-- Background Pattern -->
    <div id="background-pattern"></div>

    <!-- Header -->
    <header class="bg-gradient-to-r from-emerald-600 to-green-500 text-white shadow-xl sticky top-0 z-40">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-white/20 p-2 rounded-lg">
                    <i class="fa-solid fa-graduation-cap text-2xl"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold uppercase tracking-wide hidden md:block">Nhập Báo Bài Học Sinh</h1>
                    <h1 class="text-xl font-bold uppercase tracking-wide md:hidden">Báo Bài Online</h1>
                    <div class="flex items-center gap-2">
                         <span class="relative flex h-2 w-2">
                          <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                          <span class="relative inline-flex rounded-full h-2 w-2 bg-green-300"></span>
                        </span>
                        <p class="text-xs text-green-100 font-light hidden md:block">Đồng bộ trực tuyến</p>
                    </div>
                </div>
            </div>
            <div id="current-context" class="text-sm font-bold text-emerald-700 bg-emerald-100 px-4 py-1.5 rounded-full shadow-inner hidden animate-pulse">
            </div>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="flex-grow container mx-auto px-4 py-8 relative">
        
        <!-- VIEW 1: SELECT GRADE -->
        <section id="view-grade" class="max-w-5xl mx-auto transition-all duration-300">
            <div class="text-center mb-10">
                <h2 class="text-3xl font-bold text-emerald-800 mb-2">Chọn Khối Lớp</h2>
                <p class="text-emerald-600 mb-2">Dữ liệu được chia sẻ cho toàn trường</p>
                <!-- Thêm ngày tháng vào đây -->
                <div id="date-info-grade"></div>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-6 px-2"></div>
        </section>

        <!-- VIEW 2: SELECT CLASS -->
        <section id="view-class" class="max-w-5xl mx-auto hidden transition-all duration-300">
            <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                <button onclick="goBackToGrade()" class="text-emerald-600 hover:text-emerald-800 bg-white hover:bg-emerald-50 px-4 py-2 rounded-full shadow-sm flex items-center gap-2 font-medium transition-all">
                    <i class="fa-solid fa-arrow-left"></i> Quay lại
                </button>
                <h2 id="grade-title" class="text-2xl font-bold text-emerald-800 uppercase tracking-wider bg-white/60 px-6 py-2 rounded-xl backdrop-blur-sm">Chọn Lớp</h2>
                <div class="w-24 hidden md:block"></div>
            </div>
            <div id="class-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-4"></div>
        </section>

        <!-- VIEW 3: DASHBOARD -->
        <section id="view-dashboard" class="max-w-6xl mx-auto hidden transition-all duration-300 h-full flex flex-col">
            <!-- Header Card chứa Nút bấm và Công cụ mới -->
            <div class="glass-card p-4 rounded-2xl mb-6 shadow-sm sticky top-20 z-30">
                <!-- Dòng 1: Các nút điều khiển chính -->
                <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-4">
                    <button onclick="goBackToClass()" class="text-gray-600 hover:text-emerald-600 flex items-center gap-2 font-medium bg-white px-4 py-2 rounded-lg shadow-sm border border-gray-100 hover:border-emerald-200 transition-all">
                        <i class="fa-solid fa-arrow-left"></i> Đổi Lớp
                    </button>
                    
                    <div class="flex gap-3 w-full md:w-auto">
                        <label for="file-upload" class="flex-1 md:flex-none cursor-pointer bg-gradient-to-r from-emerald-500 to-green-500 hover:from-emerald-600 hover:to-green-600 text-white px-6 py-3 rounded-xl shadow-lg hover:shadow-emerald-500/30 transition-all flex items-center justify-center gap-3 font-bold active:scale-95 transform">
                            <i class="fa-solid fa-cloud-arrow-up text-lg"></i>
                            <span>Đăng Báo Bài</span>
                        </label>
                        <input id="file-upload" type="file" accept="image/*" multiple class="hidden" onchange="handleFileUpload(event)">
                    </div>
                </div>

                <!-- Dòng 2: Trạng thái và TIN 2 -->
                <div class="border-t border-emerald-100 pt-4 bg-emerald-50/50 rounded-lg p-3">
                    <div class="flex flex-col gap-3">
                        <!-- Tùy chọn Đã Nhập / Chưa Nhập -->
                        <div class="flex items-center gap-6">
                            <span class="font-bold text-emerald-800 text-sm whitespace-nowrap"><i class="fa-solid fa-clipboard-check"></i> Trạng thái:</span>
                            <div class="flex items-center gap-4">
                                <label class="flex items-center gap-2 cursor-pointer group">
                                    <input type="radio" name="classStatus" value="da_nhap" class="accent-emerald-600 w-5 h-5 cursor-pointer" onchange="updateClassStatus()">
                                    <span class="text-emerald-700 font-medium group-hover:text-emerald-900">Đã Nhập</span>
                                </label>
                                <label class="flex items-center gap-2 cursor-pointer group">
                                    <input type="radio" name="classStatus" value="chua_nhap" class="accent-red-500 w-5 h-5 cursor-pointer" onchange="updateClassStatus()">
                                    <span class="text-red-500 font-medium group-hover:text-red-700">Chưa Nhập</span>
                                </label>
                            </div>
                        </div>

                        <!-- Ô nhập văn bản TIN 2 -->
                        <div class="flex flex-col gap-1 w-full">
                            <span class="font-bold text-emerald-800 text-sm"><i class="fa-regular fa-message"></i> TIN 2:</span>
                            <input type="text" id="tin2-input" placeholder="Ví dụ kiểu nhập (Tin 2) GDTC: Mặc đồ TD...." 
                                   class="w-full border border-emerald-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-400 bg-white" 
                                   onchange="updateClassStatus()">
                        </div>

                        <!-- Dòng MỚI: Tùy chọn Đã Lên Tin 2 / Chưa Lên Tin 2 -->
                        <div class="flex items-center gap-6 mt-1 border-t border-emerald-100/50 pt-2">
                            <span class="font-bold text-purple-800 text-sm whitespace-nowrap"><i class="fa-solid fa-bullhorn"></i> TT Tin 2:</span>
                            <div class="flex items-center gap-4">
                                <label class="flex items-center gap-2 cursor-pointer group">
                                    <input type="radio" name="tin2Status" value="da_len_tin2" class="accent-purple-600 w-5 h-5 cursor-pointer" onchange="updateClassStatus()">
                                    <span class="text-purple-700 font-medium group-hover:text-purple-900">Đã Lên</span>
                                </label>
                                <label class="flex items-center gap-2 cursor-pointer group">
                                    <input type="radio" name="tin2Status" value="chua_len_tin2" class="accent-gray-500 w-5 h-5 cursor-pointer" onchange="updateClassStatus()">
                                    <span class="text-gray-500 font-medium group-hover:text-gray-700">Chưa Lên</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Empty State -->
            <div id="empty-state" class="hidden flex flex-col items-center justify-center py-20 text-emerald-300/50">
                <i class="fa-regular fa-folder-open text-8xl mb-4"></i>
                <p class="text-xl font-medium text-emerald-800/60">Lớp này chưa có bài nào</p>
                <p class="text-sm text-emerald-600/60 mt-2">Đăng bài ngay để mọi người cùng xem</p>
            </div>

            <!-- Gallery Grid -->
            <div id="gallery-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 pb-20"></div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="bg-white/60 backdrop-blur-md border-t border-emerald-100 py-6 mt-auto relative z-10">
        <div class="container mx-auto px-4 text-center">
            <p class="text-emerald-700 font-semibold text-sm">
                &copy; 2025 Hệ thống Báo Bài Online. Dữ liệu đồng bộ thời gian thực.
            </p>
            <p class="text-emerald-500/70 text-xs mt-2 font-light">
                Designed by TONG VO TAN PHAT <i class="fa-solid fa-heart text-red-400 animate-pulse mx-1"></i> for Education
            </p>
        </div>
    </footer>

    <!-- Modal Zoom -->
    <div id="image-modal" class="fixed inset-0 z-50 bg-emerald-900/95 backdrop-blur-sm hidden flex items-center justify-center p-4 transition-opacity duration-300" onclick="closeModal()">
        <button class="absolute top-4 right-4 text-white/80 hover:text-white text-4xl focus:outline-none w-12 h-12 flex items-center justify-center rounded-full hover:bg-white/10" onclick="closeModal()">&times;</button>
        <img id="modal-img" src="" alt="Zoomed Image" class="max-w-full max-h-[85vh] object-contain rounded-lg shadow-2xl border-4 border-white/20" onclick="event.stopPropagation()">
        <p class="absolute bottom-6 text-white/70 text-sm font-light tracking-widest uppercase">Nhấn ra ngoài để đóng</p>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-5 right-5 bg-white border-l-4 border-emerald-500 text-gray-800 px-6 py-4 rounded-r-lg shadow-2xl transform translate-y-40 opacity-0 transition-all duration-500 z-50 flex items-center gap-4 min-w-[300px]">
        <div class="bg-emerald-100 p-2 rounded-full text-emerald-600">
            <i class="fa-solid fa-check text-xl"></i>
        </div>
        <div>
            <h4 class="font-bold text-sm text-gray-900">Thông báo</h4>
            <span id="toast-message" class="text-sm text-gray-600">Nội dung thông báo</span>
        </div>
    </div>

    <script>
        // --- LOGIC ỨNG DỤNG ---
        // Sử dụng window để đảm bảo biến toàn cục
        window.GRADES = [6, 7, 8, 9];
        window.CLASSES_PER_GRADE = 10;
        window.BG_ICONS = ['fa-book', 'fa-pen-nib', 'fa-graduation-cap', 'fa-school', 'fa-calculator', 'fa-flask', 'fa-microscope', 'fa-globe', 'fa-atom', 'fa-palette', 'fa-music', 'fa-laptop-code'];

        // State
        window.currentGrade = null;
        window.currentClass = null; // "6-1"
        window.currentView = 'view-grade';
        window.globalAppData = []; 

        // --- HÀM TẠO HTML NGÀY THÁNG ---
        function getDateHtml() {
            const days = ['Chủ nhật', 'Hai', 'Ba', 'Tư', 'Năm', 'Sáu', 'Bảy'];
            const now = new Date();
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);

            const format = (d) => ({
                thu: days[d.getDay()],
                ngay: d.getDate(),
                thang: d.getMonth() + 1,
                nam: d.getFullYear()
            });

            const t = format(now);
            const tm = format(tomorrow);

            // Hàm helper để in đậm
            const b = (text) => `<span class="font-bold">"${text}"</span>`;
            // Helper cho ngày mai (tô đỏ)
            const bRed = (text) => `<span class="font-bold text-red-600">"${text}"</span>`;
            // Helper cho thứ Hai tuần sau (tô vàng đậm để dễ nhìn)
            const bYellow = (text) => `<span class="font-bold text-yellow-600">"${text}"</span>`;

            let mondayHtml = '';
            
            // LOGIC ĐẶC BIỆT: Nếu hôm nay là Thứ Sáu (5), hiện thêm dòng Thứ Hai tuần sau
            if (now.getDay() === 5) {
                const nextMonday = new Date(now);
                nextMonday.setDate(now.getDate() + 3); // Cộng thêm 3 ngày
                const mon = format(nextMonday);
                
                mondayHtml = `
                    <p class="text-yellow-600 text-sm mt-1 font-medium">
                        Tuần tới: Thứ ${bYellow("Hai")} Ngày ${bYellow(mon.ngay)} Tháng ${bYellow(mon.thang)} Năm ${bYellow(mon.nam)}.
                    </p>
                `;
            }

            return `
                <div class="mt-4 p-3 bg-white/50 rounded-xl border border-emerald-100 inline-block shadow-sm">
                    <p class="text-emerald-800 text-sm">
                        Hôm nay: Thứ ${b(t.thu)} Ngày ${b(t.ngay)} Tháng ${b(t.thang)} Năm ${b(t.nam)}.
                    </p>
                    <p class="text-red-600 text-sm mt-1 font-medium">
                        Ngày mai: Thứ ${bRed(tm.thu)} Ngày ${bRed(tm.ngay)} Tháng ${bRed(tm.thang)} Năm ${bRed(tm.nam)}.
                    </p>
                    ${mondayHtml}
                </div>
            `;
        }

        // --- RENDER ---
        function renderGrades() {
            const container = document.querySelector('#view-grade div.grid');
            // Dùng window.GRADES và window.CLASSES_PER_GRADE
            container.innerHTML = window.GRADES.map(g => `
                <button onclick="selectGrade(${g})" class="glass-card p-6 rounded-3xl shadow-lg hover:shadow-emerald-200/50 border-emerald-100 hover:border-emerald-300 transition-all hover:-translate-y-2 group relative overflow-hidden">
                    <div class="w-20 h-20 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-4 group-hover:bg-emerald-500 transition-colors shadow-inner">
                        <span class="text-3xl font-bold text-emerald-600 group-hover:text-white transition-colors">${g}</span>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-700 text-center group-hover:text-emerald-700">Khối ${g}</h3>
                    <div class="mt-3 flex justify-center">
                        <span class="bg-emerald-50 text-emerald-600 text-xs px-3 py-1 rounded-full border border-emerald-100 font-medium">
                            ${window.CLASSES_PER_GRADE} Lớp
                        </span>
                    </div>
                </button>
            `).join('');
        }

        function renderClasses(grade) {
            const container = document.getElementById('class-grid');
            let html = '';
            
            for (let i = 1; i <= window.CLASSES_PER_GRADE; i++) {
                const classId = `${grade}-${i}`;
                const displayClass = `${grade}/${i}`;
                
                const classData = window.globalAppData.filter(item => item.classId === classId);
                const count = classData.filter(item => 
                    item.type === 'image' || (!item.type && item.image)
                ).length;
                const hasData = count > 0;

                const statusDoc = classData.find(item => item.type === 'status');
                const hasTin2 = statusDoc && statusDoc.tin2 && statusDoc.tin2.trim().length > 0;
                const isDaNhap = statusDoc && statusDoc.status === 'da_nhap';
                const isDaLenTin2 = statusDoc && statusDoc.tin2Status === 'da_len_tin2';
                
                html += `
                    <button onclick="selectClass('${classId}', '${displayClass}')" class="bg-white/80 backdrop-blur p-4 rounded-2xl shadow-sm border border-emerald-50 hover:border-emerald-400 hover:shadow-lg transition-all relative group hover:-translate-y-1">
                        <div class="flex justify-between items-start mb-2">
                            <div class="text-xl font-bold text-gray-700 group-hover:text-emerald-700">Lớp ${displayClass}</div>
                            
                            <div class="flex gap-1">
                                ${isDaLenTin2 ? '<div class="w-3 h-3 bg-purple-500 rounded-full animate-pulse shadow-purple-300 shadow-lg" title="Đã lên tin 2"></div>' : ''}
                                ${hasTin2 ? '<div class="w-3 h-3 bg-yellow-400 rounded-full animate-pulse shadow-yellow-300 shadow-lg" title="Có ghi chú TIN 2"></div>' : ''}
                                ${hasData ? '<div class="w-3 h-3 bg-red-500 rounded-full animate-pulse shadow-red-300 shadow-lg" title="Có hình ảnh báo bài"></div>' : ''}
                            </div>
                        </div>
                        <div class="h-1 w-full bg-gray-100 rounded-full overflow-hidden mb-2">
                             <div class="h-full bg-emerald-500 transition-all" style="width: ${hasData ? '100%' : '0%'}"></div>
                        </div>
                        
                        <div class="text-xs text-gray-500 flex justify-between items-center mt-3">
                            <span class="${hasData ? 'text-emerald-600 font-bold bg-emerald-50 px-2 py-1 rounded-md border border-emerald-100' : 'text-gray-400'}">
                                ${hasData ? `<i class="fa-solid fa-cloud"></i> ${count}` : 'Trống'}
                            </span>
                            
                            ${isDaNhap ? '<div class="bg-green-100 text-green-600 w-6 h-6 rounded-full flex items-center justify-center shadow-sm" title="Đã nhập xong"><i class="fa-solid fa-check"></i></div>' : ''}
                        </div>
                    </button>
                `;
            }
            container.innerHTML = html;
        }

        function renderGallery() {
            const container = document.getElementById('gallery-grid');
            const emptyState = document.getElementById('empty-state');
            
            const allClassData = window.globalAppData.filter(item => item.classId === window.currentClass);
            const statusDoc = allClassData.find(item => item.type === 'status');
            
            const radioDaNhap = document.querySelector('input[name="classStatus"][value="da_nhap"]');
            const radioChuaNhap = document.querySelector('input[name="classStatus"][value="chua_nhap"]');
            const tin2Input = document.getElementById('tin2-input');
            const radioDaLen = document.querySelector('input[name="tin2Status"][value="da_len_tin2"]');
            const radioChuaLen = document.querySelector('input[name="tin2Status"][value="chua_len_tin2"]');

            if (statusDoc) {
                if (statusDoc.status === 'da_nhap') radioDaNhap.checked = true;
                else if (statusDoc.status === 'chua_nhap') radioChuaNhap.checked = true;
                else {
                    radioDaNhap.checked = false;
                    radioChuaNhap.checked = false;
                }
                
                tin2Input.value = statusDoc.tin2 || '';
                
                if (statusDoc.tin2Status === 'da_len_tin2') radioDaLen.checked = true;
                else if (statusDoc.tin2Status === 'chua_len_tin2') radioChuaLen.checked = true;
                else {
                    radioDaLen.checked = false;
                    radioChuaLen.checked = false;
                }
            } else {
                radioDaNhap.checked = false;
                radioChuaNhap.checked = false;
                tin2Input.value = '';
                radioDaLen.checked = false;
                radioChuaLen.checked = false;
            }

            const classImages = allClassData.filter(item => item.type === 'image' || (!item.type && item.image));

            document.getElementById('current-context').innerHTML = `Lớp ${window.currentClass.replace('-', '/')}`;
            document.getElementById('current-context').classList.remove('hidden');

            if (classImages.length === 0) {
                container.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            
            const sortedUploads = classImages.sort((a, b) => b.timestamp - a.timestamp);

            const dateHtml = getDateHtml();

            container.innerHTML = sortedUploads.map(item => `
                <div class="bg-white rounded-2xl shadow-md border border-emerald-50 overflow-hidden flex flex-col hover:shadow-2xl transition-all duration-300 hover:-translate-y-1 transform group">
                    <div class="relative h-56 bg-gray-100 cursor-pointer overflow-hidden bg-cover bg-center" style="background-image: url('${item.image}')" onclick="openModal('${item.image}')">
                        <div class="absolute inset-0 bg-emerald-900/0 group-hover:bg-emerald-900/30 transition-all flex items-center justify-center">
                            <i class="fa-solid fa-eye text-white text-4xl opacity-0 group-hover:opacity-100 transform scale-50 group-hover:scale-100 transition-all duration-300 drop-shadow-lg"></i>
                        </div>
                    </div>
                    
                    <div class="p-4 flex-grow flex flex-col justify-between bg-white relative">
                        <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-emerald-400 to-green-300"></div>
                        
                        <div>
                            <div class="flex items-center gap-2 text-emerald-700 font-bold text-lg mb-1">
                                <i class="fa-regular fa-clock"></i> ${item.time}
                            </div>
                            <p class="text-xs text-gray-400">Ngày: ${item.date}</p>
                        </div>
                        
                        <div class="mt-2 text-center text-[10px] bg-gray-50 p-1 rounded border border-gray-100">
                             ${dateHtml}
                        </div>

                        <div class="mt-4 pt-3 border-t border-gray-100 flex justify-end items-center">
                            <button onclick="deleteImage('${item.id}', event)" class="text-red-400 hover:text-red-600 hover:bg-red-50 p-2 rounded-lg transition-all cursor-pointer z-10 flex items-center gap-1 text-sm font-medium" title="Xóa ảnh">
                                <span>Xóa</span> <i class="fa-regular fa-trash-can text-lg"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // --- NAVIGATION ---
        function switchView(viewId) {
            ['view-grade', 'view-class', 'view-dashboard'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(viewId).classList.remove('hidden');
            window.currentView = viewId;
            window.scrollTo(0, 0);
        }

        function selectGrade(grade) {
            window.currentGrade = grade;
            document.getElementById('grade-title').innerText = `Lớp - Khối ${grade}`;
            renderClasses(grade);
            window.selectClass = selectClass; 
            switchView('view-class');
        }

        function selectClass(classId, className) {
            window.currentClass = classId;
            renderGallery();
            switchView('view-dashboard');
        }

        function goBackToGrade() {
            window.currentGrade = null;
            document.getElementById('current-context').classList.add('hidden');
            switchView('view-grade');
        }

        function goBackToClass() {
            window.currentClass = null;
            document.getElementById('current-context').classList.add('hidden');
            renderClasses(window.currentGrade);
            switchView('view-class');
        }

        // --- UI ---
        function openModal(imgSrc) {
            document.getElementById('modal-img').src = imgSrc;
            document.getElementById('image-modal').classList.remove('hidden');
        }
        function closeModal() {
            document.getElementById('image-modal').classList.add('hidden');
        }
        function showToast(message, isWarning = false) {
            const toast = document.getElementById('toast');
            const msgSpan = document.getElementById('toast-message');
            const iconDiv = toast.querySelector('div:first-child');
            const icon = iconDiv.querySelector('i');
            msgSpan.innerText = message;
            if (isWarning) {
                iconDiv.className = "bg-yellow-100 p-2 rounded-full text-yellow-600";
                icon.className = "fa-solid fa-circle-exclamation text-xl";
                toast.classList.replace('border-emerald-500', 'border-yellow-500');
            } else {
                iconDiv.className = "bg-emerald-100 p-2 rounded-full text-emerald-600";
                icon.className = "fa-solid fa-check text-xl";
                toast.classList.replace('border-yellow-500', 'border-emerald-500');
            }
            toast.classList.remove('opacity-0', 'translate-y-40');
            setTimeout(() => { toast.classList.add('opacity-0', 'translate-y-40'); }, 3000);
        }
        
        // Initial setup
        document.addEventListener('DOMContentLoaded', () => {
            renderGrades();
            generateBackgroundIcons();
            
            // Hiển thị ngày tháng ở màn hình chọn khối
            const dateInfo = getDateHtml();
            document.getElementById('date-info-grade').innerHTML = dateInfo;
        });

        function generateBackgroundIcons() {
            const container = document.getElementById('background-pattern');
            let html = '';
            for(let i = 0; i < 40; i++) {
                const randomIcon = window.BG_ICONS[Math.floor(Math.random() * window.BG_ICONS.length)];
                html += `<i class="fa-solid ${randomIcon} bg-icon" style="transform: rotate(${Math.floor(Math.random() * 360)}deg); font-size: ${2 + Math.random() * 3}rem; opacity: ${0.5 + Math.random() * 0.5};"></i>`;
            }
            container.innerHTML = html;
        }
        
        // Expose navigation functions
        window.selectGrade = selectGrade;
        window.selectClass = selectClass;
        window.goBackToGrade = goBackToGrade;
        window.goBackToClass = goBackToClass;
        window.openModal = openModal;
        window.closeModal = closeModal;
    </script>
</body>
</html>
